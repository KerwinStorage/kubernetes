# 1. å®‰è£…éƒ¨ç½²ingress-nginx

å‰è¨€ï¼šå‘æ¯”è¾ƒå¤šï¼Œpodå¯åŠ¨runningæˆåŠŸä¹Ÿå¹¶ä¸ä»£è¡¨ingresså°±èƒ½ä½¿ç”¨ï¼Œéœ€è¦è¿›å»podå†…æŸ¥çœ‹logsè¿˜æœ‰podçš„æè¿°ä¹Ÿè¦çœ‹çœ‹æ˜¯å¦æœ‰æŠ¥é”™ğŸ˜’ğŸ˜“ã€‚

æ–‡ä»¶åœ°å€ï¼š

- https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.3/deploy/static/provider/baremetal/deploy.yaml
- https://github.com/kubernetes/ingress-nginx/blob/controller-v1.1.3/deploy/static/provider/baremetal/deploy.yaml

ç›¸å…³é“¾æ¥ï¼š

- GitHubï¼šhttps://github.com/kubernetes/ingress-nginx
- kuberneteï¼šhttps://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress

## 1.1 éƒ¨ç½²

```bash
# æŸ¥çœ‹å½“å‰ç‰ˆapiç‰ˆæœ¬
kubectl explain Ingress
KIND:     Ingress
VERSION:  networking.k8s.io/v1
....
```

**æ³¨ï¼šæŸ¥çœ‹ingresså’Œè‡ªå·±æœ¬åœ°çš„k8sç‰ˆæœ¬æ˜¯å¦å¯¹åº”ä¸Šï¼Œåœ¨[GitHub](https://github.com/kubernetes/ingress-nginx#supported-versions-table)ä¸Šæœ‰è¡¨æ ¼å‚è€ƒã€‚**

```bash
mkdir -p /root/ingress && cd /root/ingress
wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.3/deploy/static/provider/baremetal/deploy.yaml

cat deploy.yaml | grep image:
image: k8s.gcr.io/ingress-nginx/controller:v1.1.3@sha256:31f47c1e202b39fadecf822a9b76370bd4baed199a005b3e7d4d1455f4fd3fe2
image: k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
image: k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660

# æ›¿æ¢é•œåƒ
sed  -i 's#k8s.gcr.io/ingress-nginx/controller:v1.1.3@sha256:31f47c1e202b39fadecf822a9b76370bd4baed199a005b3e7d4d1455f4fd3fe2#registry.cn-hangzhou.aliyuncs.com/imges/controller:v1.1.3#' deploy.yaml
sed  -i 's#k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660#registry.cn-hangzhou.aliyuncs.com/chenby/kube-webhook-certgen:v1.1.1#' deploy.yaml

# åç«¯svcè®¿é—®æ”¹æˆNodePort
apiVersion: v1
kind: Service
metadata:
  ....
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  ....
  type: NodePort

# èµ·pod
kubectl apply -f .

POD_NAMESPACE=ingress-nginx
POD_NAME=$(kubectl get pods -n $POD_NAMESPACE -l app.kubernetes.io/name=ingress-nginx --field-selector=status.phase=Running -o name)
kubectl exec $POD_NAME -n $POD_NAMESPACE -- /nginx-ingress-controller --version

kubectl get pod -n ingress-nginx
```

**æ³¨ï¼šé•œåƒå·²ç»ä»å¤–ç½‘ä¸Šä¼ åˆ°è‡ªå·±åœ¨é˜¿é‡Œäº‘çš„é•œåƒä¸­å¿ƒã€‚**

## 1.2 å¯ç”¨åç«¯ï¼Œå†™å…¥é…ç½®æ–‡ä»¶æ‰§è¡Œ

```bash
mkdir -p /root/ingress ; cd /root/ingress
cat > backend.yaml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: default-http-backend
  labels:
    app.kubernetes.io/name: default-http-backend
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: default-http-backend
  template:
    metadata:
      labels:
        app.kubernetes.io/name: default-http-backend
    spec:
      terminationGracePeriodSeconds: 60
      containers:
      - name: default-http-backend
        image: registry.cn-hangzhou.aliyuncs.com/imges/defaultbackend-amd64:1.5 
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 30
          timeoutSeconds: 5
        ports:
        - containerPort: 8080
        resources:
          limits:
            cpu: 10m
            memory: 20Mi
          requests:
            cpu: 10m
            memory: 20Mi
---
apiVersion: v1
kind: Service
metadata:
  name: default-http-backend
  namespace: kube-system
  labels:
    app.kubernetes.io/name: default-http-backend
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app.kubernetes.io/name: default-http-backend
EOF
```

éƒ¨ç½²ï¼š

```bash
kubectl apply -f backend.yaml

kubectl get svc -n ingress-nginx
NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx-controller             NodePort    10.98.68.205    <none>        80:31460/TCP,443:32201/TCP   72m
ingress-nginx-controller-admission   ClusterIP   10.99.214.213   <none>        443/TCP                      72m
```

# 2. æµ‹è¯•ingress

## 2.1 podå’Œsvcåˆ›å»º

```bash
mkdir -p /root/ingress ; cd /root/ingress
cat > /root/ingress/deploy-demo.yaml <<EOF
#åˆ›å»ºserviceä¸ºmyapp
apiVersion: v1
kind: Service
metadata:
  name: myapp
  namespace: default
spec:
  selector:
    app: myapp
    release: canary
  ports:
  - name: http
    targetPort: 80
    port: 80
---
#åˆ›å»ºåç«¯æœåŠ¡çš„pod
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-backend-pod
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
      release: canary
  template:
    metadata:
      labels:
        app: myapp
        release: canary
    spec:
      containers:
      - name: myapp
        image: ikubernetes/myapp:v2
        ports:
        - name: http
          containerPort: 80
EOF
kubectl apply -f deploy-demo.yaml

# æŸ¥çœ‹podå¯åŠ¨
kubectl get pod -l app=myapp
NAME                                READY   STATUS    RESTARTS   AGE
myapp-backend-pod-9f9b5bd95-5d487   1/1     Running   0          23m
myapp-backend-pod-9f9b5bd95-k87tc   1/1     Running   0          23m
myapp-backend-pod-9f9b5bd95-vssh7   1/1     Running   0          23m
```

## 2.2 ingressåˆ›å»º

```bash
cat > /root/ingress/ingress-myapp.yaml <<EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-myapp
  annotations:
    kubernetes.io/ingress.class: "nginx"
spec:
  rules:
  - host: "myapp.magedu.com"
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: myapp
            port:
              number: 80
EOF
kubectl apply -f ingress-myapp.yaml
 
kubectl get ingress
NAME                  CLASS    HOSTS              ADDRESS         PORTS     AGE
ingress-myapp         <none>   myapp.magedu.com   192.168.80.49   80        22m
```

å¦‚æœæœ‰æŠ¥é”™ï¼š`Error from server (InternalError): error when creating "ingress-tomcat-tls.yaml": Internal error occurred: failed calling webhook "validate.nginx.ingress.kubernetes.io": failed to call webhook: Post "https://ingress-nginx-controller-admission.ingress-nginx.svc:443/networking/v1/ingresses?timeout=10s": remote error: tls: internal error root@k8s-master01:~/ingress/tls# kubectl get validatingwebhookconfigurations`ã€‚

```bash
kubectl get validatingwebhookconfigurations
ingress-nginx-admission
kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission
```

windowsä¿®æ”¹æœ¬åœ°hostæ–‡ä»¶ï¼Œè¿›è¡Œè®¿é—® `C:\Windows\System32\drivers\etc\hosts`ï¼Œk8såœ°å€ç»‘å®šåŸŸåã€‚

```bash
k8s ipåœ°å€ myapp.magedu.com
```

Linuxä¿®æ”¹æœ¬åœ°hostsæ–‡ä»¶ï¼Œ`/etc/hosts`ï¼Œk8såœ°å€ç»‘å®šåŸŸåã€‚

```bash
k8s ipåœ°å€ myapp.magedu.com
curl myapp.magedu.com:31460
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
```

http://myapp.magedu.com:31460

![img](https://img2023.cnblogs.com/blog/1740081/202304/1740081-20230422160602785-1338565808.png)

## 2.3 ä½¿ç”¨httpsè®¿é—®

```bash
# 1.å‡†å¤‡è¯ä¹¦ï¼Œåœ¨k8sçš„masterèŠ‚ç‚¹æ“ä½œ
mkdir -p /root/ingress/tls ; cd /root/ingress/tls
openssl genrsa -out tls.key 2048
openssl req -new -x509 -key tls.key -out tls.crt -subj /C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=myapp.magedu.com

# 2.ç”Ÿæˆsecretï¼Œåœ¨k8sçš„masterèŠ‚ç‚¹æ“ä½œ
kubectl create secret tls myapp-ingress-secret --cert=tls.crt --key=tls.key

# 3.æŸ¥çœ‹secret
kubectl get secret | grep myapp
myapp-ingress-secret                 kubernetes.io/tls                     2      100s

# 4.æŸ¥çœ‹tomcat-ingress-secretè¯¦ç»†ä¿¡æ¯
kubectl describe secrets myapp-ingress-secret
Name:         myapp-ingress-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  kubernetes.io/tls

Data
====
tls.crt:  1310 bytes
tls.key:  1704 bytes

# 5.åˆ›å»ºingress
cat > ingress-tomcat-tls.yaml <<EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-myapp-https
  annotations:
    kubernetes.io/ingress.class: "nginx"
spec:
  tls:
  - hosts:
    - myapp.magedu.com
    secretName: myapp-ingress-secret
  rules:
  - host: "myapp.magedu.com"
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: myapp
            port:
              number: 80
EOF

# 6.åˆ›å»ºingress
kubectl apply -f ingress-tomcat-tls.yaml
ingress.networking.k8s.io/ingress-myapp-https created

kubectl get ingress
NAME                  CLASS    HOSTS              ADDRESS         PORTS     AGE
ingress-myapp         <none>   myapp.magedu.com   192.168.80.49   80        22m
ingress-myapp-https   <none>   myapp.magedu.com   192.168.80.49   80, 443   9m10s
```

## 2.4 éªŒè¯https

![img](https://img2023.cnblogs.com/blog/1740081/202304/1740081-20230422160824552-1553978567.png)

# 3. hostNetworkæ–¹å¼å®ç°nodeIP:80è®¿é—®

## 3.1 ä¿®æ”¹æ–‡ä»¶å’Œä¸»æœºæ‰“æ ‡ç­¾

ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š

```bash
vim deploy.yaml
kind: Deployment	//æ”¹ä¸ºDaemonSetæ§åˆ¶å™¨
# replicas: 1		//åˆ é™¤replicas
spec:
  template:
    spec:
      hostNetwork: true	//ä½¿ç”¨HostNetwork
      nodeSelector:		//ä¿®æ”¹èŠ‚ç‚¹é€‰æ‹©ï¼Œäº²å’Œåº¦
        custom/ingress-controller-ready: true
```

ä¸»æœºæ‰“ä¸Šlableï¼ˆmasterä¸»æœºä¸éƒ¨ç½²ï¼Œç›´æ¥æ‰“ä¸Šæ±¡ç‚¹ï¼‰ï¼š

```bash
kubectl get node
kubectl label nodes k8s-node01 custom/ingress-controller-ready=true
kubectl label nodes k8s-node02 custom/ingress-controller-ready=true
kuectl taint nodes k8s-master node-role.kubernetes.io/master=true:NoSchedule
kubectl apply -f deploy.yaml

# æŸ¥çœ‹ingress podçš„æƒ…å†µ
kubectl get pod -n ingress-nginx -owide
NAME                                   READY   STATUS      RESTARTS      AGE   IP              NODE         NOMINATED NODE   READINESS GATES
ingress-nginx-admission-create-9lrgn   0/1     Completed   0             65m   172.16.58.253   k8s-node02   <none>           <none>
ingress-nginx-admission-patch-n75rg    0/1     Completed   0             65m   172.16.58.254   k8s-node02   <none>           <none>
ingress-nginx-controller-5q227         1/1     Running     4 (63m ago)   64m   192.168.80.48   k8s-node01   <none>           <none>
ingress-nginx-controller-n64bk         1/1     Running     0             61m   192.168.80.49   k8s-node02   <none>           <none>
```

**æ³¨ï¼šè¿™é‡Œ80ç«¯å£ä¸èƒ½è¢«å…¶ä»–æœåŠ¡å ç”¨ï¼Œå¦åˆ™`controller`å®¹å™¨ä¼šå¯åŠ¨å¤±è´¥ã€‚**

## 3.2 éªŒè¯ç»“æœ

```bash
mkdir -p /root/ingress ; cd /root/ingress
cat > /root/ingress/deploy-demo.yaml <<EOF
#åˆ›å»ºserviceä¸ºmyapp
apiVersion: v1
kind: Service
metadata:
  name: myapp
  namespace: default
spec:
  selector:
    app: myapp
    release: canary
  ports:
  - name: http
    targetPort: 80
    port: 80
---
#åˆ›å»ºåç«¯æœåŠ¡çš„pod
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-backend-pod
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
      release: canary
  template:
    metadata:
      labels:
        app: myapp
        release: canary
    spec:
      containers:
      - name: myapp
        image: ikubernetes/myapp:v2
        ports:
        - name: http
          containerPort: 80
EOF
kubectl apply -f deploy-demo.yaml
kubectl get pod -l app=myapp
NAME                                READY   STATUS    RESTARTS   AGE
myapp-backend-pod-9f9b5bd95-9zfh4   1/1     Running   0          47m
myapp-backend-pod-9f9b5bd95-cfdzs   1/1     Running   0          47m
myapp-backend-pod-9f9b5bd95-gvfx5   1/1     Running   0          47m
```

åˆ›å»ºingressï¼š

```bash
cat > /root/ingress/ingress-myapp.yaml <<EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-myapp
  annotations:
    kubernetes.io/ingress.class: "nginx"
spec:
  rules:
  - host: "myapp.magedu.com"
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: myapp
            port:
              number: 80
EOF
kubectl apply -f ingress-myapp.yaml
 
kubectl get ingress
kubectl get ingress
NAME            CLASS    HOSTS              ADDRESS                       PORTS   AGE
ingress-myapp   <none>   myapp.magedu.com   192.168.80.48,192.168.80.49   80      45m
```

æœ¬åœ°è§£æï¼š

- 192.168.80.48 myapp.magedu.com
- 192.168.80.49 myapp.magedu.com

![img](https://img2023.cnblogs.com/blog/1740081/202304/1740081-20230427173937572-17232363.png)

# 4. ingressé«˜å¯ç”¨

| ä¸»æœº       | åœ°å€          | ç«¯å£                                                         |
| ---------- | ------------- | ------------------------------------------------------------ |
| k8s-node01 | 192.168.80.48 | nginxå¯åŠ¨ç«¯å£ï¼š3080ï¼Œè´Ÿè½½å‡è¡¡ç«¯å£ï¼šæ ¹æ®ingress svcè‡ªå·±ç”Ÿæˆçš„NodePortçš„ç«¯å£ |
| k8s-node02 | 192.168.80.49 | nginxå¯åŠ¨ç«¯å£ï¼š3080ï¼Œè´Ÿè½½å‡è¡¡ç«¯å£ï¼šæ ¹æ®ingress svcè‡ªå·±ç”Ÿæˆçš„NodePortçš„ç«¯å£ |
| vip        | 192.168.80.66 | è®¿é—®ç«¯å£ï¼š80                                                 |

é€šè¿‡ `keepalived`+`nginx` å®ç° `nginx-ingress-controller`é«˜å¯ç”¨

## 4.1 ä¿®æ”¹æ–‡ä»¶å’Œä¸»æœºæ‰“æ ‡ç­¾

```bash
vim deploy.yaml
kind: Deployment	//æ”¹ä¸ºDaemonSetæ§åˆ¶å™¨
# replicas: 1		//åˆ é™¤replicas
spec:
  template:
    spec:
      hostNetwork: true	//ä½¿ç”¨HostNetwork
      nodeSelector:		//ä¿®æ”¹èŠ‚ç‚¹é€‰æ‹©ï¼Œäº²å’Œåº¦
        custom/ingress-controller-ready: true

apiVersion: v1
kind: Service
metadata:
  name: ingress-nginx-controller
  namespace: ingress-nginx
  ....
spec:
  ....
  type: NodePort #åç«¯svcè®¿é—®æ”¹æˆNodePort

# nodeä¸»æœºæ‰“æ ‡ç­¾
kubectl label nodes k8s-node01 custom/ingress-controller-ready=true
kubectl label nodes k8s-node02 custom/ingress-controller-ready=true
kubectl taint nodes k8s-master node-role.kubernetes.io/master=true:NoSchedule
```

## 4.1 nginxé…ç½®

```bash
apt install nginx keepalived -y
sudo useradd nginx -G www-data
```

**æ³¨ï¼šè¿™é‡Œå› ä¸º`80`ç«¯å£ç»™`nginx-ingress-controller`ï¼Œæ‰€ä»¥è¿™é‡Œ`nginx`çš„ç«¯å£åˆ†é…åˆ°3080ä¸Šï¼Œå¦‚æœåé¢ä¸æƒ³è®¿é—®`pod`çš„`ingress`å¸¦ç«¯å£è®¿é—®ä¹Ÿå¯ä»¥ç›´æ¥å°†`80`ç«¯å£ç»™`nginx`ï¼Œç„¶å`nginx`è‡ªåŠ¨è´Ÿè½½åˆ°`ingress`çš„`svc`éšæœºåˆ†é…çš„ç«¯å£ä¸Šå»è®¿é—®podçš„svcã€‚**

**ä¿®æ”¹nginxé…ç½®ï¼š**

- k8s-node01ã€k8s-node02

```bash
# ä¿®æ”¹é»˜è®¤ç«¯å£
cd /etc/nginx/sites-enabled
cat default
listen 3080 default_server;
listen [::]:3080 default_server;

# é‡å¯nginx
systemctl restart  nginx.service
netstat -lntup  | grep 3080
tcp        0      0 0.0.0.0:3080            0.0.0.0:*               LISTEN      263469/nginx: maste
tcp6       0      0 :::3080                 :::*                    LISTEN      263469/nginx: maste

# æŸ¥çœ‹ingressæœ¬åœ°ç«¯å£
kubectl get svc  -n ingress-nginx
NAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx-controller             NodePort    10.107.200.122   <none>        80:30152/TCP,443:31001/TCP   27m #åç«¯è®¿é—®ç«¯å£
ingress-nginx-controller-admission   ClusterIP   10.109.213.65    <none>        443/TCP                      27m
```

æ·»åŠ è´Ÿè½½ï¼š

- k8s-node01ã€k8s-node02

```bash
cd /etc/nginx ; cp nginx.conf nginx.conf_bak
cat > nginx.conf <<EOF
load_module /usr/lib/nginx/modules/ngx_stream_module.so;
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

stream {

    log_format  main  '$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent';

    access_log  /var/log/nginx/k8s-access.log  main;

    upstream ingress {
       server 192.168.80.48:30152;   # #è¿™é‡Œé…ç½®æˆè¦è®¿é—®çš„åœ°å€
       server 192.168.80.49:30152;
    }

    server {
       listen 80; #éœ€è¦ç›‘å¬çš„ç«¯å£
       proxy_pass ingress;
    }
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;

}
EOF

# æ£€æŸ¥æ ¼å¼
nginx -t
```

## 4.2 keepalivedé…ç½®

- k8s-node01

```bash
cat > /etc/keepalived/keepalived.conf << EOF
global_defs { 
   notification_email { 
     acassen@firewall.loc 
     failover@firewall.loc 
     sysadmin@firewall.loc 
   } 
   notification_email_from Alexandre.Cassen@firewall.loc  
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id NGINX_MASTER
} 

# æ£€æŸ¥è„šæœ¬
vrrp_script check_nginx {
    script "/etc/keepalived/check_nginx.sh"
}

vrrp_instance VI_NGINX { 
    state MASTER 
    interface ens33 # ä¿®æ”¹ä¸ºå®é™…ç½‘å¡å
    virtual_router_id 51 # VRRP è·¯ç”± IDå®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹æ˜¯å”¯ä¸€çš„ 
    priority 100    # ä¼˜å…ˆçº§ï¼Œå¤‡æœåŠ¡å™¨è®¾ç½® 90 
    advert_int 1    # æŒ‡å®šVRRP å¿ƒè·³åŒ…é€šå‘Šé—´éš”æ—¶é—´ï¼Œé»˜è®¤1ç§’ 
    authentication { 
        auth_type PASS      
        auth_pass 1111 
    }  
    # è™šæ‹ŸIP
    virtual_ipaddress { 
        192.168.80.66/24
    } 
    track_script {
        check_nginx
    } 
}
EOF
```

- k8s-node02

```bash
cat > /etc/keepalived/keepalived.conf << EOF
global_defs { 
   notification_email { 
     acassen@firewall.loc 
     failover@firewall.loc 
     sysadmin@firewall.loc 
   } 
   notification_email_from Alexandre.Cassen@firewall.loc  
   smtp_server 127.0.0.1 
   smtp_connect_timeout 30 
   router_id NGINX_BACKUP
} 

# æ£€æŸ¥è„šæœ¬
vrrp_script check_nginx {
    script "/etc/keepalived/check_nginx.sh"
}

vrrp_instance VI_NGINX { 
    state BACKUP 
    interface ens33 # ä¿®æ”¹ä¸ºå®é™…ç½‘å¡å
    virtual_router_id 51 # VRRP è·¯ç”± IDå®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹æ˜¯å”¯ä¸€çš„ 
    priority 90     # ä¼˜å…ˆçº§ï¼Œå¤‡æœåŠ¡å™¨è®¾ç½® 90 
    advert_int 1    # æŒ‡å®šVRRP å¿ƒè·³åŒ…é€šå‘Šé—´éš”æ—¶é—´ï¼Œé»˜è®¤1ç§’ 
    authentication { 
        auth_type PASS      
        auth_pass 1111 
    }  
    # è™šæ‹ŸIP
    virtual_ipaddress { 
        192.168.80.66/24
    } 
    track_script {
        check_nginx
    } 
}
EOF
```

keepalived æ£€æŸ¥è„šæœ¬ï¼ˆæ³¨æ„è„šæœ¬å†…çš„ç«¯å£æ˜¯éœ€è¦ç›‘å¬çš„ç«¯å£ï¼‰ï¼š

```bash
cat > /etc/keepalived/check_nginx.sh  <<"EOF"
#!/bin/bash
count=$(ss -antp |grep 80 |egrep -cv "grep|$$")

if [ "$count" -eq 0 ];then
    exit 1
else
    exit 0
fi
EOF

chmod +x /etc/keepalived/check_nginx.sh
```

é‡å¯æœåŠ¡ï¼š

```bash
systemctl daemon-reload
systemctl start nginx keepalived
systemctl enable nginx keepalived
```

æŸ¥çœ‹æ•ˆæœï¼š

æœ¬åœ°è§£æï¼š192.168.80.66 myapp.magedu.com

![img](https://img2023.cnblogs.com/blog/1740081/202305/1740081-20230504182158535-1644207249.png)

# é—®é¢˜å¤„ç†ï¼š

```bash
# æŸ¥çœ‹podè¿è¡Œæƒ…å†µ
kubectl describe pod -n ingress-nginx ingress-nginx-controller-74c6bcdc65-dttbv
Events:
  Type     Reason       Age                  From                      Message
  ----     ------       ----                 ----                      -------
  Normal   Scheduled    115s                 default-scheduler         Successfully assigned ingress-nginx/ingress-nginx-controller-74c6bcdc65-dttbv to k8s-node02
  Warning  FailedMount  114s (x2 over 115s)  kubelet                   MountVolume.SetUp failed for volume "webhook-cert" : secret "ingress-nginx-admission" not found
  Normal   Pulled       112s                 kubelet                   Container image "registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.1.1" already present on machine
  Normal   Created      112s                 kubelet                   Created container controller
  Normal   Started      112s                 kubelet                   Started container controller
  Normal   RELOAD       110s                 nginx-ingress-controller  NGINX reload triggered due to a change in configuration
```

**æ—¥å¿—æŠ¥é”™ä¿¡æ¯ï¼š****MountVolume.SetUp failed for volume "webhook-cert" : secret "ingress-nginx-admission" not found****ã€‚**

**å‚è€ƒæ–‡æ¡£ï¼šhttps://juejin.cn/post/7099413476967514125#heading-5**

**æŸ¥çœ‹ï¼š**

```bash
kubectl get secret -A|grep ingress
ingress-nginx     default-token-bk2hf                              kubernetes.io/service-account-token   3      10m
ingress-nginx     ingress-nginx-admission                          Opaque                                3      10m
ingress-nginx     ingress-nginx-admission-token-fg9jn              kubernetes.io/service-account-token   3      10m
ingress-nginx     ingress-nginx-token-qd9n9                        kubernetes.io/service-account-token   3      10m
```

ä¿®æ”¹å¦‚ä¸‹ï¼š

```bash
vim deploy.yaml
404       terminationGracePeriodSeconds: 300
405       volumes:
406         - name: webhook-cert
407           secret:
408             secretName: ingress-nginx-admission-token-fg9jn # ä¿®æ”¹æˆæˆ‘ä»¬ä¸Šé¢æ‰¾åˆ°çš„secret
```

é‡æ–°éƒ¨ç½²ï¼š

```bash
kubectl apply -f deploy.yaml
# æŸ¥çœ‹æ—¥å¿—çœ‹æœ‰æ²¡æœ‰ä¹‹å‰çš„æŠ¥é”™
kubectl describe pod -n ingress-nginx ingress-nginx-controller-85bf97579b-zgvdh
Events:
  Type    Reason     Age   From                      Message
  ----    ------     ----  ----                      -------
  Normal  Scheduled  15m   default-scheduler         Successfully assigned ingress-nginx/ingress-nginx-controller-85bf97579b-zgvdh to k8s-node02
  Normal  Pulled     15m   kubelet                   Container image "registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.1.1" already present on machine
  Normal  Created    15m   kubelet                   Created container controller
  Normal  Started    15m   kubelet                   Started container controller
  Normal  RELOAD     15m   nginx-ingress-controller  NGINX reload triggered due to a change in configuration
```

ğŸ™ˆğŸ™‰ğŸ™ŠğŸµ